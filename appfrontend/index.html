<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumer Behavior Tracker</title>
    <script src="http://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC1',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <script src="http://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="http://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="http://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="http://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.0.1/dist/js/leaflet.extra-markers.min.js"></script>
    <script src="http://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="http://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="http://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .map-container {
            position: relative;
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 5px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            z-index: 1000;
        }
        .leaflet-heatmap-layer {
          opacity: 0.8;
        }
        .map-legend {
            position: absolute;
            bottom: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 13px;
            /* Scrollable properties */
            max-height: 200px; /* Limits height to roughly 5-6 items */
            overflow-y: auto;  /* Adds vertical scrollbar when content exceeds max-height */
            width: 160px;      /* Ensures consistent width */
            border: 1px solid #e5e7eb;
        }

        /* Optional: Style the scrollbar for a cleaner look in Dark Mode */
        .map-legend::-webkit-scrollbar {
            width: 6px;
        }
        .map-legend::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 10px;
        }
        .map-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
		}	
		#slideshow-bg {
            filter: brightness(0.9); /* 0.9 is much closer to the original photo clarity */

        /* Optional: add a subtle zoom effect */
        .bg-zoom {
            transform: scale(1.05);	
	    #slideshow-bg {
            background-color: #1a202c; /* A dark gray so it doesn't flash bright white */
            background-size: cover;
            background-position: center;
			transition: background-image 1s ease-in-out; /* Smooth fade between images */
        }
		#totalConsumers, #activeLocations, #conversionRate {
            text-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2); /* Adds a subtle shadow behind the numbers */
            letter-spacing: -1px;
        }
		header h1, header button {
            text-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Adds a subtle glow effect to buttons on hover */
        header button:hover {
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-transparent font-sans leading-normal tracking-normal text-gray-800 dark:text-gray-200">
    <div id="slideshow-bg" class="fixed inset-0 -z-20 bg-cover bg-center transition-all duration-1000 ease-in-out"></div>
    <div class="fixed inset-0 -z-10 bg-white/40 dark:bg-gray-900/60"></div>

    <!-- Login/Register Modal -->
    <div id="authModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative p-8 bg-white dark:bg-gray-800 w-96 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-4 text-center">Login or Register</h3>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                    <input type="text" id="username" name="username" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="flex justify-between space-x-2">
                    <button type="button" id="registerBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark">Register</button>
                    <button type="submit" id="loginBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600">Login</button>
                </div>
            </form>
            <p id="authMessage" class="mt-4 text-center text-sm font-medium"></p>
        </div>
    </div>
	
	<div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm mb-6 border border-gray-100 dark:border-gray-700">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-lg font-bold text-gray-800 dark:text-white">Filter Dashboard</h2>
            <div class="flex items-center space-x-3">
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase">Start Date</label>
                    <input type="date" id="filterStartDate" class="p-2 text-sm border rounded-md dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase">End Date</label>
                    <input type="date" id="filterEndDate" class="p-2 text-sm border rounded-md dark:bg-gray-700 dark:text-white">
                </div>
                <button onclick="applyDateFilter()" class="mt-4 bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-md text-sm font-bold transition">
                    Apply Filter
                </button>
                <button onclick="resetDateFilter()" class="mt-4 text-gray-500 hover:text-gray-700 text-sm font-medium">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div id="dashboard" class="container mx-auto p-4 hidden">
        <header class="flex flex-col sm:flex-row justify-between items-center py-4 px-6 mb-8 bg-white/10 dark:bg-gray-900/40 backdrop-blur-md rounded-xl border border-white/20 shadow-lg">
            <h1 class="text-3xl font-black text-white drop-shadow-md mb-4 sm:mb-0 tracking-tight">
                Consumer <span class="text-yellow-400">Dashboard</span>
            </h1>
			
			<div class="flex flex-wrap items-center justify-center gap-3">
                <button id="addActivityBtn" class="bg-primary/80 hover:bg-primary text-white font-bold py-2 px-4 rounded-lg backdrop-blur-sm border border-white/20 shadow-md transition-all transform hover:scale-105 active:scale-95 text-sm flex items-center">
                    <i class="fas fa-plus-circle mr-2"></i> Add Activity
                </button>
				
				<button id="refreshBtn" class="bg-blue-500/80 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg backdrop-blur-sm border border-white/20 shadow-md transition-all transform hover:scale-105 active:scale-95 text-sm flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>

                <button id="logoutBtn" class="bg-red-500/80 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg backdrop-blur-sm border border-white/20 shadow-md transition-all transform hover:scale-105 active:scale-95 text-sm flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </header>
	
        <!-- Main Metrics Section -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Total Consumers Card -->
            <div class="bg-white/10 dark:bg-gray-900/20 backdrop-blur-md p-6 rounded-lg shadow-md border border-white/20">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Total Consumers</p>
                        <p id="totalConsumers" class="text-4xl font-black mt-1 text-primary-dark dark:text-yellow-400 drop-shadow-md">0</p>
                    </div>
                    <i class="fas fa-users text-primary text-3xl opacity-90"></i>
                </div>
            </div>

            <!-- Active Locations Card -->
            <div class="bg-white/10 dark:bg-gray-900/20 backdrop-blur-md p-6 rounded-lg shadow-md border border-white/20">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Active Locations</p>
                        <p id="activeLocations" class="text-4xl font-black mt-1 text-primary-dark dark:text-yellow-400 drop-shadow-md">0</p>
                    </div>
                    <i class="fas fa-map-marker-alt text-primary text-3xl opacity-90"></i>
                </div>
            </div>

            <!-- Conversion Rate Card -->
            <div class="bg-white/10 dark:bg-gray-900/20 backdrop-blur-md p-6 rounded-lg shadow-md border border-white/20">
                 <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Conversion Rate</p>
                        <p id="conversionRate" class="text-4xl font-black mt-1 text-primary-dark dark:text-yellow-400 drop-shadow-md">0%</p>
                    </div>
                    <i class="fas fa-chart-line text-primary text-3xl opacity-90"></i>
                </div>
            </div>
        </section>

        <!-- Charts and Map Section -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Hourly Activity Chart -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold mb-4">Hourly Activity</h2>
                <div class="chart-container">
                    <canvas id="hourlyActivityChart"></canvas>
                </div>
            </div>

            <!-- Demographics Chart -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold mb-4">Demographics</h2>
                <div class="chart-container">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Recommendations and Overview Map Section -->
        <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8 items-start">
            <!-- Recommendations Card -->
            <div class="lg:col-span-5 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 h-full">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i> Recommendations
                </h2>
                <div class="space-y-4">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg text-primary">Optimize Peak Hours</h3>
                        <p class="text-sm mt-1">Focus on staffing and promotions between <span id="peakHours" class="font-bold text-primary-dark dark:text-yellow-400"></span> to capitalize on high traffic.</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg text-primary">Target Key Demographics</h3>
                        <div id="targetDemographicsOutput" class="mt-2 text-sm">
                            <p class="text-gray-500 italic">Loading analysis...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overview Map Card -->
            <div class="lg:col-span-7 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Overview Map</h2>
                    <button id="toggleMapViewBtn" class="bg-primary/10 hover:bg-primary/20 text-primary dark:text-primary-dark py-1.5 px-3 rounded-md border border-primary/20 transition duration-300 text-xs font-bold uppercase tracking-wider">
                        <i class="fas fa-layer-group mr-1"></i> Switch View
                    </button>
                </div>
                
                <div class="relative">
                    <div id="map" class="map-container" style="height: 450px;"></div>
                    
                    <div id="mapLegend" class="map-legend dark:bg-gray-900 dark:text-white border border-gray-200 dark:border-gray-700">
                        <h4 class="font-bold mb-2 border-b pb-1 text-xs">Item Category</h4>
                        </div>
                </div>
            </div>
        </section>
			 <!-- Data Management Section -->
        <section class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4">Data Management</h2>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">              
                <button id="exportCsvBtn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300 text-sm">Export to CSV</button>
            </div>
        </section>
    </div>

    <!-- Modals (Add Data Forms) -->
    <!-- Add Activity Data Modal -->
    <div id="addActivityModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div class="relative p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
            <button class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" onclick="closeActivityModal()">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold mb-4">Add Consumer Activity Data</h3>
			<h4 class="text-lg font-semibold mt-4 mb-2">Individual Consumer Interactions</h4>
                <div id="interaction-inputs" class="space-y-3 p-3 border border-dashed rounded-md dark:border-gray-600">
                </div>
                <button type="button" id="addInteractionField" class="text-primary text-sm font-semibold hover:text-primary-dark mt-2">
                <i class="fas fa-plus-circle mr-1"></i> Add Interaction (Browse/Purchase/Return)
                </button>
            <!-- Geolocation Status Message -->
            <p id="geolocationStatus" class="text-sm mb-4 text-center"></p>
            <form id="activityForm" class="space-y-4">
			    <div>
                    <label for="activityDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                    <input type="date" id="activityDate" name="activityDate" readonly 
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 dark:bg-gray-600 cursor-not-allowed focus:ring-0">
                </div>
                <div>
                    <label for="activityTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Time of Day</label>
                    <input type="text" id="activityTime" name="activityTime" readonly 
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 dark:bg-gray-600 cursor-not-allowed focus:ring-0">
                </div>
                <div>
                    <label for="activityLat" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Location Latitude</label>
                    <input type="number" step="any" id="activityLat" name="activityLat" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>			
                <div>
                    <label for="activityLon" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Location Longitude</label>
                    <input type="number" step="any" id="activityLon" name="activityLon" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>				              
                <div>
                    <label for="activityCount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Consumer Count</label>
                    <input type="number" id="activityCount" name="activityCount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="activityAge" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Age Group</label>
                    <select id="activityAge" name="activityAge" required
					    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-dark focus:ring focus:ring-primary-dark focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Age Range...</option>
                        <option value="15-20">15-20</option>
                        <option value="21-25">21-25</option>
                        <option value="26-30">26-30</option>
                        <option value="31-35">31-35</option>
                        <option value="36-40">36-40</option>
                        <option value="41-45">41-45</option>
                        <option value="46-50">46-50</option>
                        <option value="51-55">51-55</option>
                        <option value="56+">56+</option>
                    </select>
                </div>    
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark">Add Data</button>
            </form>
        </div>
    </div>
	
    <script> 
	    const groceryData = {
            "Fruits": ["Apples", "Grapes", "Oranges", "Avocados", "Peaches", "Pineapple", "Pears", "Apricots", "Bananas", "Berries", "Cherries", "Kiwi", "Lemons", "Limes", "Melons", "Nectarines", "Papaya", "Plums", "Pomegranate", "Watermelon"],
            "Vegetables": ["Potatoes", "Tomatoes", "Onions", "Carrots", "Lettuce", "Broccoli", "Peppers", "Garlic", "Broccoli", "Cauliflower", "Eggplant", "Cucumbers", "Corn", "Spinach", "Salad Greens","Artichokes", "Basil", "Beets", "Cabbage", "Sprouts", "Peppers", "Zucchini"],
            "Meat": ["Chicken", "Game Meat", "Turkey", "Beef", "Pork", "Rabbit", "Bacon", "Hot Dogs", "Steak", "Ground Turkey", "Deli Meat", "Ham", "Sausage"],
            "Fish and shellfish": ["Mackerel", "Alaska Pollock", "Salmon", "Cod", "Tilapia", "Tuna","Catfish", "Lobster", "Crab", "Oysters", "Bream", "Tilapia", "Haliburt"],
            "Breakfast & Dairy": ["Milk", "Eggs", "Yogurt", "Cheese", "Oats", "Granola", "Grits", "Pancake mix", "Instant", "Cereal"],
            "Bakery": ["Whole Wheat", "Dinner Rolls", "Sandwich", "Croutons", "White Bread", "Pies", "Muffins", "Pastries", "Cookies","Tortillas Corn", "Donuts", "Hamburger Buns", "Cake", "Bagels", "Hotdog Buns", "Tortillas Flour"],
            "Beverages": ["Water", "Coffee", "Milk", "Juice", "Club Soda", "Tea", "Beer", "Champagne", "Soft Drinks", "Liquor", "Diet Soft Drinks", "Energy Drinks"],
            "Baking": ["Flour", "Baking Powder", "Butter", "Milk", "Eggs", "Baking Soda", "Bread Crumbs", "Cake Decor", "Cake Mix", "Peaches", "Chocolate Powder", "Cocoa", "Cornmeal", "Cornstarch", "Food Coloring", "Frosting", "Muffin mix", "Pie Crust", "Sugar Brown", "Sugar Powdered", "Yeast"],
            "Wine": ["Red", "White", "Ros√©", "Sparkling", ],
            "Condiments, Spices & Sauces": ["Salt", "Sugar", "BBQ Sauce", "Catsup", "Cocktail Sauce", "Pepper", "Oregano", "Cinnamon", "Ketchup", "Mayonnaise", "Mustard", "Honey", "Hot Sauce", "Cooking Spray", "Horseradish", "Lemon Juice", "Olive Oil", "Relish", "Salad Dressing", "Salsa", "Steak Sauce", "Soy Sauce", "Sweet & Sour", "Teriyaki", "Vegetable Oil", "Vinegar"],
			"Seasoning": ["Basil", "Bay Leaves", "BBQ Seasoning", "Cinnamon", "Cloves", "Cumin", "Curry", "Dill", "Garlic Powder", "Garlic Salt", "Gravy Mix", "Italian Seasoning", "Marinade", "Meat Tenderizer", "Oregano", "Paprika", "Pepper", "Poppy Seed", "Soup Mix", "Vanilla Extract"],
            "Canned Goods": ["Olives (Black)", "Soup", "Tuna", "Olives (Green)", "Applesauce", "Baked Beans", "Black Beans", "Broth", "Bullion Cubes", "Canned Fruit", "Canned Vegetables", "Chilli", "Jam/Jelly", "Creamed Corn", "Pasta Sauce", "Peanut Butter", "Chilli", "Pickles", "Pie Filling", "Mushrooms"],
			"Paper Products": ["Aluminium Foil", "Coffe Filters", "Cups", "Garbage Bags", "Napkins", "Paper Plates", "Paper Towels", "Plastic Bags", "Plastic Cutlery", "Plastic Wrap", "Waxed Paper", "Straws"],
            "Snacks": ["Chips", "Crackers", "Pretzels", "Popcorn", "Peanuts", "Nuts", "Candy", "Cookis", "Dried Fruit", "Gelatin", "Seeds", "Granolar Bars", "Gums", "Raisins", "Potato Chips", "Pudding", "Tortilla Chips"],
            "Baby Items": ["Baby Food", "Diapers", "Wet Wipes", "Moisturizing Lotion", "Diaper Cream", "Formula"],
            "Pasta/Rice": ["Spaghetti", "Macaroni", "Noodles", "White Rice", "Lasagna", "Mac $ Cheese", "Burger Helper", "Brown Rice", "Rice Mix", "Couscous"],
			"Pets": ["Cats Food", "Cat Sand", "Dog Food", "Shampoo", "Treats", "Flue Treatment"],
			"Misc. Items": ["Batteries", "Charcoal", "Greeting Cards"],
			"Refridgerated": ["Buffer", "Cheddar Cheese", "Milk", "Processed Cheese", "Polony", "Yoghurt", "Ice Cream", "Sower Cream", "Mozzarella", "Maheu"],
			"Cleaning": ["Air Freshener", "Bleach", "Dish Soap", "Dishwasher Detergent", "Fabric Softener", "Glass Spray", "Laundry Soap", "Polish", "Sponges", "Vacuum Bags"],
			"Personal Care": ["Bath Soap", "Bug Repellent", "Conditioner", "Cotton Swabs", "Dental Floss", "Deodorant", "Facial Tissue", "Family Planning", "Feminine Products", "Pads", "Hair Spray", "Hand Soap", "Lip Care", "Lotion", "Makeup", "Mouthwash", "Razors/Blades", "Shampoo", "Shaving Cream", "Sunscreen", "Toilet Tissue", "Toothbrush", "Toothpaste"],
        };
		
		const groceryImages = [
            "https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&q=90&w=1920", // 1. Main Aisle
			"https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&q=80&w=1920",
			"https://images.unsplash.com/photo-1583258292688-d0213dc5a3a8?auto=format&fit=crop&q=90&w=1920",  // Refrigerated
            "https://images.unsplash.com/photo-1578916171728-46686eac8d58?auto=format&fit=crop&q=80&w=1920",
            "https://images.unsplash.com/photo-1543168256-418811576931?auto=format&fit=crop&q=80&w=1920",
			"https://images.unsplash.com/photo-1583258292688-d0213dc5a3a8?auto=format&fit=crop&q=90&w=1920"
		];
		
		let currentImgIndex = 0;		
        // Store charts, map, and heatmap layers instance globally for updates
        let allActivityData = []; // <--- Master copy for filtering
		let hourlyActivityChart, demographicsChart, map;
        let heatLayers = {};
        let clusterLayers = {};
        let currentMapMode = 'heatmap'; // 'heatmap' or 'cluster'
        const categoryColors = ['#5D5CDE', '#34D399', '#FBBF24', '#F87171', '#60A5FA', '#8B5CF6'];
		
		function updateBackground() {
            const bgContainer = document.getElementById('slideshow-bg');
            if (bgContainer && groceryImages.length > 0) {
                // Change the image
                bgContainer.style.backgroundImage = `url('${groceryImages[currentImgIndex]}')`;
                
                // Logic: Move to next image, or back to 0 if at the end of the list
                currentImgIndex = (currentImgIndex + 1) % groceryImages.length;
            }

    // CRITICAL NEW GLOBAL VARIABLE: Stores the data currently displayed (cleared on Refresh)
        let localActivityData = {
            activity: [],
            demographics: [],
            dashboardMetrics: { totalConsumers: 0, activeLocations: 0, conversionRate: '0%' },
            targetKeyDemographics: { targetAgeGroup: 'N/A', keyInteraction: 'N/A', keyCategory: 'N/A' }
        };
		
		}

        // Start the background timer as soon as the page is ready
        document.addEventListener('DOMContentLoaded', () => {
            updateBackground(); // Show first image immediately
                setInterval(updateBackground, 5000); // Swap images every 5 seconds
        });
		
        // ---- API UTILITIES ----
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                ...options.headers,
                'Content-Type': 'application/json'
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                throw new Error('Unauthorized');
            }
            return response;
        }

        // ---- MODAL AND UI FUNCTIONS ----
        function showActivityModal() {
            document.getElementById('addActivityModal').classList.remove('hidden');
			document.getElementById('interaction-inputs').innerHTML = ''; // Clear previous fields
            addInteractionField(); // Add the first interaction field          
			
			// Auto-generate current date (YYYY-MM-DD)
			const now = new Date();
			const today = now.toISOString().split('T')[0];
			document.getElementById('activityDate').value = today;
			
			// --- NEW: Auto-generate current time (HH:MM) ---
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');
			document.getElementById('activityTime').value = `${hours}:${minutes}`;
			
         // Attempt to get current geolocation when the modal is shown
            getGeolocation();
        }
        function closeActivityModal() { document.getElementById('addActivityModal').classList.add('hidden'); }

        function addInteractionField() {
            const inputsContainer = document.getElementById('interaction-inputs');
            const groupId = Date.now(); 
            const newField = document.createElement('div');
            newField.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600 mb-4 interaction-group';

            // Generate the sub-category options from our data
            let subCatOptions = Object.keys(groceryData).map(cat => `<option value="${cat}">${cat}</option>`).join('');

            newField.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold uppercase text-gray-500">Grocery Item</span>
                    <button type="button" class="text-red-500 hover:text-red-700 remove-interaction-field"><i class="fas fa-trash"></i></button>
                </div>				
                <div class="grid grid-cols-1 gap-3 mb-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Behavior</label>
                        <select name="groupBehaviour" required class="w-full p-2 text-sm border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option value="Purchasing">Purchasing</option>
                            <option value="Browsing">Browsing</option>
                            <option value="Returning">Returning</option>
                        </select>
                        <input type="hidden" name="groupCategory" value="Groceries">
                    </div>
                </div>
        
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Sub-Category</label>
                        <select onchange="populateItems(this, '${groupId}')" name="subCategory" required class="w-full p-2 text-sm border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option value="">Select Category...</option>
                            ${subCatOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Specific Item</label>
                        <select name="itemName" id="item-select-${groupId}" required class="w-full p-2 text-sm border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option value="">Select Item...</option>
                        </select>
                    </div>
                </div>
            `;
            inputsContainer.appendChild(newField);
            newField.querySelector('.remove-interaction-field').addEventListener('click', () => newField.remove());
        }
		
        function handleCategoryChange(selectElement, groupId) {
            const dynamicArea = document.getElementById(`dynamic-item-area-${groupId}`);
    
            // Since we only have groceries, we always show the sub-category dropdown
            let subCatOptions = Object.keys(groceryData).map(cat => `<option value="${cat}">${cat}</option>`).join('');
    
            dynamicArea.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Section (Sub-Category)</label>
                        <select onchange="populateItems(this, '${groupId}')" name="subCategory" required class="w-full p-2 text-sm border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option value="">Select Section...</option>
                            ${subCatOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Specific Item</label>
                        <select name="itemName" required class="item-list-dropdown w-full p-2 text-sm border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            <option value="">Select Item...</option>
                        </select>
                    </div>
                </div>
            `;
        }

            function populateItems(subCatSelect, groupId) {
                const itemDropdown = document.getElementById(`item-select-${groupId}`);
                const selectedSection = subCatSelect.value;
    
                // Clear existing options
                itemDropdown.innerHTML = '<option value="">Select Item...</option>';
    
                if (selectedSection && groceryData[selectedSection]) {
                    groceryData[selectedSection].forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item;
                        opt.textContent = item;
                        itemDropdown.appendChild(opt);
                    });
                }
            }
        // Helper to add a new item row within a specific group
        function addItemToGroup(groupId) {
            const container = document.getElementById(`items-${groupId}`);
            const newItemDiv = document.createElement('div');
            newItemDiv.className = 'flex space-x-2';
            newItemDiv.innerHTML = `
                <input type="text" name="itemName" placeholder="Item name..." required class="flex-1 p-2 text-sm rounded-md border border-gray-300 dark:bg-gray-800 dark:border-gray-600">
                <button type="button" onclick="this.parentElement.remove()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(newItemDiv);
        }
		
        // Custom message box to replace alert()
        function showMessage(message, isError = false) {
            const messageBox = document.createElement('div');
            messageBox.innerHTML = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div class="relative p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl w-80 text-center">
                        <h3 class="text-xl font-bold mb-4">${isError ? 'Error' : 'Info'}</h3>
                        <p>${message}</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="mt-4 py-2 px-4 rounded-md bg-primary text-white hover:bg-primary-dark">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
        }

        // ---- GEOLOCATION FUNCTIONS ----
        function getGeolocation() {
            const statusMessage = document.getElementById('geolocationStatus');
            statusMessage.textContent = 'Attempting to find your location...';
            statusMessage.className = 'text-sm mb-4 text-center text-gray-500 dark:text-gray-400';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('activityLat').value = position.coords.latitude;
                        document.getElementById('activityLon').value = position.coords.longitude;
                        statusMessage.textContent = 'Location found successfully! You can edit the values if needed.';
                        statusMessage.className = 'text-sm mb-4 text-center text-green-500 dark:text-green-400';
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        statusMessage.textContent = 'Could not find your location. Please enter coordinates manually.';
                        statusMessage.className = 'text-sm mb-4 text-center text-red-500 dark:text-red-400';
                    }
                );
            } else {
                statusMessage.textContent = 'Geolocation is not supported by your browser.';
                statusMessage.className = 'text-sm mb-4 text-center text-red-500 dark:text-red-400';
            }
        }

        // ---- CHART FUNCTIONS ----
        function initCharts() {
            const hourlyCtx = document.getElementById('hourlyActivityChart').getContext('2d');
            hourlyActivityChart = new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Consumers',
                        data: [],
                        borderColor: '#5D5CDE',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            const demoCtx = document.getElementById('demographicsChart').getContext('2d');
            demographicsChart = new Chart(demoCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Demographics',
                        data: [],
                        backgroundColor: [
                            '#5D5CDE', '#34D399', '#FBBF24', '#F87171', '#60A5FA', '#8B5CF6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateHourlyChart(data) {
            const hourlyCounts = data.reduce((acc, curr) => {
                const hour = curr.time.split(':')[0];
                const label = `${hour}:00`;// Always group to the top of the hour
                acc[label] = (acc[label] || 0) + curr.count;
                return acc;
            }, {});
			
			// Sort labels to ensure graph goes from 00:00 to 23:00
            const labels = Object.keys(hourlyCounts).sort();
            const counts = labels.map(label => hourlyCounts[label]);
            hourlyActivityChart.data.labels = labels;
            hourlyActivityChart.data.datasets[0].data = counts;
            hourlyActivityChart.update();
        }        

        function updateDemographicsChart(data) {
            // CRITICAL FIX: Map to the new dynamic field names (age_group and count)
            const labels = data.map(d => d.age_group);
            const counts = data.map(d => d.count);
    
            // Sort data for consistent chart display (optional but recommended)
            // Note: Pie charts use raw counts, and Chart.js calculates the percentages automatically.
    
            demographicsChart.data.labels = labels;
            demographicsChart.data.datasets[0].data = counts; 
            demographicsChart.update();
        }

        // ---- MAP FUNCTIONS ----
        function initOverviewMap() {
            if (map) { map.remove(); }
            map = L.map('map', {center: [34.052235, -118.243683], zoom: 12});
            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function clearMapLayers() {
            // 1. Remove all stored heat layers from the map
            for (const key in heatLayers) {
                if (map.hasLayer(heatLayers[key])) {
                    map.removeLayer(heatLayers[key]);
                }
            }
            // 2. Remove all stored cluster layers from the map
            for (const key in clusterLayers) {
                if (map.hasLayer(clusterLayers[key])) {
                    map.removeLayer(clusterLayers[key]);
                }
            }
            // 3. Clear the objects to hold the new layers
            heatLayers = {};
            clusterLayers = {};
        }
          
        function updateMap(activityData) {
           console.log("Updating map with sub-category data:", activityData);

            // CRITICAL: Clear layers AND clear the global storage objects
			//This must happen only here,at the start of a full data refresh.
			// 1. Clear existing layers and reset the legend header
            clearMapLayers(); 
            
            const legend = document.getElementById('mapLegend');
            legend.innerHTML = '<h4 class="font-bold mb-2">Item Categories</h4>';

            // Flatten the activity data (Logic remains the same, assuming it works)
			// 2. Flatten data using sub-category (interaction.category)
            const flattenedPoints = [];
            activityData.forEach(activity => {                
                activity.interactions.forEach(interaction => {
				    // Pull the specific sub-category (e.g., Bakery, Produce, Dairy)
                    const subCatName = interaction.category || "Uncategorized";
					
                    flattenedPoints.push({
                        lat: activity.lat,
                        lon: activity.lon,
						// Use the weight of the specific interaction, NOT the total group count
                        count: interaction.weight || 1,
                        // We tell the map to use the Sub-Category (Fruits, Meat, etc.) for the Legend colors 
                        category: subCatName, // Using the sub-category as the primary category for the map
                        behaviour: interaction.type || 'N/A',
                        item: interaction.item || 'N/A'
                        });
                   });
            });

            if (flattenedPoints.length === 0) {
                console.log("No activity data with coordinates and interactions to display on map.");
                legend.innerHTML += `<p class="text-xs text-gray-500">No data available.</p>`;
                return;
            }
 
            // 3. Group the flattened data by Sub-Category
            const groupedData = flattenedPoints.reduce((acc, curr) => {
                const rawCategory = curr.category;
                const key = rawCategory.trim().toLowerCase().replace(/\s/g, '-'); 
        
                if (!acc[key]) {
                    acc[key] = {
                        heat: [], 
                        cluster: [],
                        label: rawCategory // Store original label for legend
                    };
                }
                // Leaflet Heat expects [lat, lon, intensity]
                acc[key].heat.push([curr.lat, curr.lon, curr.count]);
                
                // Add Marker for Cluster view
                acc[key].cluster.push(L.marker([curr.lat, curr.lon]).bindPopup(
                    `<b>Sub-Category:</b> ${curr.category}<br>` +
					`<b>Item:</b> ${curr.item}<br>` +
					`<b>Consumers:</b> ${curr.count}`
                ));
                return acc;
            }, {});

            // 4. Generate Layers and Legend items
            const categories = Object.keys(groupedData).sort();
    
            categories.forEach((key, index) => {
                const data = groupedData[key];
                const color = categoryColors[index % categoryColors.length];

                // Create the Heat Layer
                heatLayers[key] = L.heatLayer(data.heat, {
                    radius: 25,
                    blur: 15,
                    gradient: { 0.4: color, 0.6: color, 1.0: color }
                });

                // Create the Cluster Layer
                const clusterGroup = L.markerClusterGroup();
                clusterGroup.addLayers(data.cluster);
                clusterLayers[key] = clusterGroup; 

                // 5. Build Legend Item (Checklist)
                const legendItem = document.createElement('div');
                legendItem.className = 'map-legend-item flex items-center mb-1';
                legendItem.innerHTML = `
                    <input type="checkbox" id="legend-${key}" data-category="${key}" checked class="mr-2 cursor-pointer">
                    <div class="w-3 h-3 rounded-full" style="background-color: ${color};"></div>
                    <label for="legend-${key}" class="text-xs cursor-pointer ml-2 text-gray-700 dark:text-gray-200 uppercase font-medium">
                        ${data.label}
                    </label>
                `;
                legend.appendChild(legendItem);

                // Add toggle event listener
                legendItem.querySelector('input').addEventListener('change', updateMapDisplay);
            });

            // 6. Zoom map to fit the data points
            const allPoints = flattenedPoints.map(d => [d.lat, d.lon]);
            if (allPoints.length > 0) {
                map.fitBounds(L.latLngBounds(allPoints), { padding: [30, 30] });
            }

            // Refresh display based on current mode (Heatmap/Cluster)
            updateMapDisplay();
        }
		
        // New function to update the map based on current state
        function updateMapDisplay() {
            const toggleButton = document.getElementById('toggleMapViewBtn');
    
            // 1. Remove ALL existing dynamic layers from the MAP (Visual removal)
            //    We manually remove them here instead of calling clearMapLayers()
            for (const category in heatLayers) {
                if (map.hasLayer(heatLayers[category])) map.removeLayer(heatLayers[category]);
            }
            for (const category in clusterLayers) {
                if (map.hasLayer(clusterLayers[category])) map.removeLayer(clusterLayers[category]);
            }

            const checkboxes = document.querySelectorAll('#mapLegend input[type="checkbox"]');

            toggleButton.textContent = currentMapMode === 'heatmap' ? 'Switch to Clusters' : 'Switch to Heatmap';

            // 2. Iterate over the checkboxes to decide which layers to ADD back to the map
            checkboxes.forEach(checkbox => {
                const category = checkbox.dataset.category;
                if (checkbox.checked) {
                    if (currentMapMode === 'heatmap' && heatLayers[category]) {
                        map.addLayer(heatLayers[category]);
                    } else if (currentMapMode === 'cluster' && clusterLayers[category]) {
                        map.addLayer(clusterLayers[category]);
                    }
                }
            });
        }
        function toggleMapView() {
            currentMapMode = currentMapMode === 'heatmap' ? 'cluster' : 'heatmap';
            updateMapDisplay();
        }

        // ---- RECOMMENDATIONS FUNCTIONS ----
        function updateRecommendations(hourlyData) {
            const hourlyCounts = hourlyData.reduce((acc, curr) => {
                const hour = new Date(`2000/01/01 ${curr.time}`).getHours();
                const label = `${hour}:00`;
                acc[label] = (acc[label] || 0) + curr.count;
                return acc;
            }, {});

            if (Object.keys(hourlyCounts).length > 0) {
                let peakHours = [];
                let maxCount = 0;

                for (const time in hourlyCounts) {
                    if (hourlyCounts[time] > maxCount) {
                        maxCount = hourlyCounts[time];
                        peakHours = [time];
                    } else if (hourlyCounts[time] === maxCount) {
                        peakHours.push(time);
                    }
                }

                document.getElementById('peakHours').textContent = peakHours.join(' & ');
            } else {
                document.getElementById('peakHours').textContent = 'N/A';
            }
        }
        // Inside copy7-auth.html, add this new function:

        function updateTargetDemographics(demographics) {
            const outputDiv = document.getElementById('targetDemographicsOutput');
            // Deconstruct the new keyItem field
            const { targetAgeGroup, keyInteraction, keyCategory, keyItem } = demographics;

            if (targetAgeGroup === 'N/A' || keyItem === 'N/A') {
                outputDiv.innerHTML = '<p class="text-sm text-gray-500">No activity data available to generate recommendations.</p>';
                return;
            }

            let recommendation = `<p class="mb-2 text-base text-gray-800">Your **Primary Target Demographic** is the **${targetAgeGroup}** age group.</p>`;
    
            // Highlight the specific item instead of the category
            recommendation += `<p class="mb-2 text-sm text-gray-700">The most popular specific product is **${keyItem}**, often associated with **${keyInteraction}** behavior.</p>`;

            // Item-specific recommendations
            if (keyInteraction === 'Browsing') {
                recommendation += `<p class="p-3 mt-4 text-sm bg-yellow-50 border border-yellow-200 rounded-md">
                    <strong>üí° Recommendation:</strong> Many users in the **${targetAgeGroup}** group are looking at **${keyItem}** but not buying. Consider a "Bundle Deal" where purchasing **${keyItem}** gives a discount on a related item in the **${keyCategory}** category to seal the deal.
                </p>`;
            } else if (keyInteraction === 'Purchasing') {
                recommendation += `<p class="p-3 mt-4 text-sm bg-green-50 border border-green-200 rounded-md">
                    <strong>üí° Recommendation:</strong> **${keyItem}** is a top seller for **${targetAgeGroup}**! Ensure high stock levels and consider placing high-margin items from the **${keyCategory}** section right next to the **${keyItem}** shelf to drive impulse buys.
                </p>
                <p class="text-xs text-gray-500 mt-2">Inventory Alert: Check stock for "${keyItem}" immediately.</p>`;
            } else if (keyInteraction === 'Returning') {
                recommendation += `<p class="p-3 mt-4 text-sm bg-red-50 border border-red-200 rounded-md">
                    <strong>üí° Recommendation:</strong> There is a high return rate for **${keyItem}** among the **${targetAgeGroup}** demographic. Investigate if there is a sizing issue (for apparel) or a quality batch issue specifically affecting **${keyItem}**.
                </p>`;
            }

            outputDiv.innerHTML = recommendation;
        }
		function clearDashboardDisplay() {
            // 1. Reset Metrics to 0/N/A
            document.getElementById('totalConsumers').textContent = '0';
            document.getElementById('activeLocations').textContent = '0';
            document.getElementById('conversionRate').textContent = '0';
    
            // 2. Robustly Clear Charts by replacing the entire data object
            if (hourlyActivityChart) {
			                // Hourly Chart Reset
                hourlyActivityChart.data = {
                    labels: [],
                    datasets: [{ 
                        label: 'Consumers', 
                        data: [], 
                        borderColor: '#5D5CDE', 
                        tension: 0.1 
                    }]				
            };
			            hourlyActivityChart.update();
		        }

            if (demographicsChart) {
                // Demographics Chart Reset (Ensuring correct type and colors are maintained)
                demographicsChart.data = {
                    labels: [],
                    datasets: [{ 
                        label: 'Demographics', 
                        data: [], 
                        // Must retain colors or Chart.js might throw errors
                        backgroundColor: [
                            '#5D5CDE', '#34D399', '#FBBF24', '#F87171', '#60A5FA', '#8B5CF6'
                        ]
                    }]
                };
                demographicsChart.update();
            }
			
            // 3. Clear Recommendations
            document.getElementById('peakHours').textContent = 'N/A';
            document.getElementById('targetDemographicsOutput').innerHTML = '<p class="text-sm text-gray-500">Data cleared. Awaiting new activity entry!</p>';

            // 4. Clear Map layers and reset legend
            clearMapLayers(); // This existing function removes layers and clears stored data
            const legend = document.getElementById('mapLegend');
            legend.innerHTML = '<h4 class="font-bold mb-2">Item Categories</h4><p class="text-xs text-gray-500 dark:text-gray-400">Dashboard data has been cleared.</p>';
        
            // CRITICAL STEP: When refreshing, reset the local data buffer to an empty set
            localActivityData.activity = [];
            localActivityData.demographics = [];
            localActivityData.dashboardMetrics = { totalConsumers: 0, activeLocations: 0, conversionRate: '0%' };
            localActivityData.targetKeyDemographics = { targetAgeGroup: 'N/A', keyInteraction: 'N/A', keyCategory: 'N/A' };
        }		
		
		function resetDashboardState() {
		    // 1. Close and reset the Add Activity Modal form
			document.getElementById('addActivityModal').classList.add('hidden');
			document.getElementById('activityForm').reset();
			
			// 2. Clear dynamic interaction fields and re-add one for a clean slate
			const interactionInputs = document.getElementById('interaction-inputs');
			if (interactionInputs) {
			    interactionInputs.innerHTML = '';
				addInteractionField();
			}
		}	
		
        // NEW FUNCTION: Handles the actual display update from the local buffer
        function updateDashboardDisplay(data) {
            document.getElementById('totalConsumers').textContent = data.dashboardMetrics.totalConsumers;
            document.getElementById('activeLocations').textContent = data.dashboardMetrics.activeLocations;
            document.getElementById('conversionRate').textContent = data.dashboardMetrics.conversionRate;

            updateHourlyChart(data.activity);
            updateDemographicsChart(data.demographics);
            updateRecommendations(data.activity);
            updateMap(data.activity);
            updateTargetDemographics(data.targetKeyDemographics);			
        }

// ---- DATA AND METRICS CALCULATOR ----
        
        // NEW FUNCTION: Calculates all metrics, demographics, and recommendations client-side
        // This ensures the dashboard reflects ONLY the data present in the provided activity array.
        function calculateClientSideStats(activityData) {
            let totalConsumers = 0;
            const locations = new Set();
            const ageCounts = {};
            let totalInteractions = 0;
            let purchaseCount = 0;
            let interactionCounts = {};
            let categoryCounts = {};
			let itemNameCounts = {};

            // Pass 1: Gather raw numbers for metrics and demographics
            activityData.forEach(activity => {
                totalConsumers += activity.count;
                locations.add(`${activity.lat},${activity.lon}`);

                // Demographics
                const ageGroup = activity.age; // Assuming 'age' is a string like '25-34'
                ageCounts[ageGroup] = (ageCounts[ageGroup] || 0) + activity.count;

                // Interactions for Conversion Rate/Key Demographics
                activity.interactions.forEach(interaction => {
                    totalInteractions++;
                    if (interaction.type === 'Purchasing') {
                        purchaseCount++;
                    }
                    interactionCounts[interaction.type] = (interactionCounts[interaction.type] || 0) + 1;
                    categoryCounts[interaction.category] = (categoryCounts[interaction.category] || 0) + 1;
                
				    itemNameCounts[interaction.item] = (itemNameCounts[interaction.item] || 0) + 1;
				});
            });

            // Calculate Metrics
            const activeLocations = locations.size;
            const conversionRate = totalInteractions > 0 
                ? ((purchaseCount / totalInteractions) * 100).toFixed(1) + '%'
                : '0%';
            
            // Calculate Demographics
            const demographics = Object.keys(ageCounts).map(age_group => ({
                age_group,
                count: ageCounts[age_group]
            })).sort((a, b) => b.count - a.count);

            // Calculate Recommendations (Target Demographic/Interaction)
            let targetAgeGroup = demographics.length > 0 ? demographics[0].age_group : 'N/A';
            let keyInteraction = Object.keys(interactionCounts).sort((a, b) => interactionCounts[b] - interactionCounts[a])[0] || 'N/A';
            let keyCategory = Object.keys(categoryCounts).sort((a, b) => categoryCounts[b] - categoryCounts[a])[0] || 'N/A';
            let keyItem = Object.keys(itemNameCounts).sort((a, b) => itemNameCounts[b] - itemNameCounts[a])[0] || 'N/A';
			
            return {
                dashboardMetrics: { totalConsumers, activeLocations, conversionRate },
                demographics: demographics,
                targetKeyDemographics: { targetAgeGroup, keyInteraction, keyCategory, keyItem }
            };
        }
		
		function applyDateFilter() {
            const start = document.getElementById('filterStartDate').value;
            const end = document.getElementById('filterEndDate').value;

            if (!start || !end) {
                showMessage("Please select both a start and end date.", true);
                return;
            }

            // 1. Filter the Master Copy based on the date string (YYYY-MM-DD)
            const filteredActivities = allActivityData.filter(act => {
                return act.date >= start && act.date <= end;
            });

            // 2. Re-calculate all stats (Metrics, Charts, Demographics) for this subset
            const filteredStats = calculateClientSideStats(filteredActivities);
    
            // 3. Push to UI
            updateDashboardDisplay({
                activity: filteredActivities,
                ...filteredStats
            });
        }
		
		function resetDateFilter() {
		    document.getElementById('filterStartDate').value = '';
			document.getElementById('filterEndDate').value = '';
			
			// Return to the original localActivityData (the full set)
			updateDashboardDisplay(localActivityData);
		}

        // ---- DATA AND API HANDLERS ----
        async function fetchDashboardData() {
            try {
                const response = await fetchWithAuth('https://red-o3v6.onrender.com/api/dashboard');
                let data = await response.json();
                
				allActivityData = data.activity; // Store the master copy here
                // Store the full response data locally (used during login/initial load)
                localActivityData = data; 
                
                // Now, update the dashboard using this new local data
                updateDashboardDisplay(localActivityData);
				
            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
            }
        }
 
        async function submitActivityData(e) {
            e.preventDefault();
            const form = document.getElementById('activityForm');
            const lat = parseFloat(document.getElementById('activityLat').value);
            const lon = parseFloat(document.getElementById('activityLon').value);
    
            const groups = document.querySelectorAll('.interaction-group');
            const interactions = [];

            groups.forEach(group => {               
				const behaviour = group.querySelector('[name="groupBehaviour"]').value;
                const category = group.querySelector('[name="groupCategory"]').value;
				const subCategory = group.querySelector('[name="subCategory"]')?.value || "Groceries";
                const itemInputs = group.querySelectorAll('[name="itemName"]');

                itemInputs.forEach(input => {
				    const itemName = input.value.trim();
                    if (itemName !== "") {
                        // Each item is pushed as an individual interaction object
                        interactions.push({ 
                            type: behaviour, 
                            item: itemName, 
                            category: subCategory,
                        });
                    }
                });
            });

            if (interactions.length === 0) {
                showMessage("Please add at least one item.", true);
                return;
            }

            const newActivity = {
			    date: document.getElementById('activityDate').value,
                time: document.getElementById('activityTime').value,
                lat: lat,
                lon: lon,
                count: parseInt(document.getElementById('activityCount').value),
                age: document.getElementById('activityAge').value,           
                interactions: interactions 
            };

            try {
                const response = await fetchWithAuth('https://red-o3v6.onrender.com/api/activity', {
                    method: 'POST',
                    body: JSON.stringify(newActivity)
                });
        
                if (response.ok) {
                    // Update local state and dashboard
                    localActivityData.activity.push(newActivity); 
                    const updatedStats = calculateClientSideStats(localActivityData.activity);
                    Object.assign(localActivityData, updatedStats);
                    updateDashboardDisplay(localActivityData);
            
                    // UI Cleanup
                    closeActivityModal();
                    form.reset();
                    document.getElementById('interaction-inputs').innerHTML = '';
                    addInteractionField(); 
                    if (!isNaN(lat) && !isNaN(lon)) map.flyTo([lat, lon], 15);
                }
            } catch (error) {
                console.error('Error adding activity:', error);
            } 
        }
        // ---- INITIALIZATION AND EVENT LISTENERS ----
        document.addEventListener('DOMContentLoaded', function() {
		    updateBackground(); // Show first image immediately
			setInterval(updateBackground, 8000); // Change every 8 seconds
			
            initCharts();
            initOverviewMap();

            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                map.invalidateSize();
                fetchDashboardData();
            } else {
                document.getElementById('authModal').classList.remove('hidden');
            }

            document.getElementById('authForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const authMessage = document.getElementById('authMessage');

                try {
                    const response = await fetch('https://red-o3v6.onrender.com/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        localStorage.setItem('token', result.token);
                        localStorage.setItem('userId', result.userId);
                        document.getElementById('authModal').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        map.invalidateSize();
                        fetchDashboardData();
                    } else {
                        authMessage.textContent = result.message;
                        authMessage.className = 'mt-4 text-center text-sm font-medium text-red-500';
                    }
                } catch (error) {
                    authMessage.textContent = 'Failed to connect to server.';
                    authMessage.className = 'mt-4 text-center text-sm font-medium text-red-500';
                }
            });

            document.getElementById('registerBtn').addEventListener('click', async function() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const authMessage = document.getElementById('authMessage');

                try {
                    const response = await fetch('https://red-o3v6.onrender.com/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const result = await response.json();
                    authMessage.textContent = result.message;
                    authMessage.className = 'mt-4 text-center text-sm font-medium ' + (response.ok ? 'text-green-500' : 'text-red-500');
                } catch (error) {
                    authMessage.textContent = 'Failed to connect to server.';
                    authMessage.className = 'mt-4 text-center text-sm font-medium text-red-500';
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('peakHours').textContent = '';
            });

            document.getElementById('addActivityBtn').addEventListener('click', showActivityModal);
            document.getElementById('activityForm').addEventListener('submit', submitActivityData);
			
			document.getElementById('refreshBtn').addEventListener('click', () => {
			    // 1. Ensure all input forms are closed and reset
				    resetDashboardState();
				
                // 2. Clear Dashboard Display (Visual reset to 0s and N/A)
				        clearDashboardDisplay();
				                            	
            });
            document.getElementById('toggleMapViewBtn').addEventListener('click', toggleMapView);
            document.getElementById('addInteractionField').addEventListener('click', addInteractionField);
			
            function exportData(format) {
                const messageBox = document.createElement('div');
                messageBox.innerHTML = `
                    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                        <div class="relative p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl w-80 text-center">
                            <h3 class="text-xl font-bold mb-4">Exporting Data</h3>
                            <p>Exporting dashboard data as ${format}. This is a simulated action.</p>
                            <button onclick="this.parentElement.parentElement.remove()" class="mt-4 py-2 px-4 rounded-md bg-primary text-white hover:bg-primary-dark">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }            
            document.getElementById('exportCsvBtn').addEventListener('click', async () => {
            try {
                // 1. Get the current filter values from your input fields
                const startDate = document.getElementById('filterStartDate').value;
                const endDate = document.getElementById('filterEndDate').value;

                // 2. Build the URL with query parameters if filters are set
                let url = 'https://red-o3v6.onrender.com/api/activity/csv';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
        
                if (params.toString()) {
                    url += `?${params.toString()}`;
                }

                // 3. Fetch from the server (using the new URL with dates)
                const response = await fetchWithAuth(url);
        
                if (!response.ok) {
                    throw new Error('Server responded with an error during CSV export.');
                }

                const csvData = await response.text();
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', downloadUrl);
        
                // 4. Set a dynamic filename so you know it's filtered
                const fileName = (startDate || endDate) 
                    ? `activity_filtered_${startDate || 'start'}_to_${endDate || 'end'}.csv` 
                    : 'consumer_activity_all.csv';
            
                a.setAttribute('download', fileName);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
        
                showMessage(`Export successful! ${fileName} downloaded.`, false);
            } catch (error) {
                console.error('Export failed:', error);
                showMessage("Export failed. Please check if the server is running.", true);
            }
        });
    });
    </script>
</body>
</html>